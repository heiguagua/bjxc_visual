<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chinawiserv.dsp.dir.mapper.apply.DirDataApplyMapper">

    <!-- 开启二级缓存 -->
    <cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>

    <!--&lt;!&ndash; 通用查询映射结果 &ndash;&gt;
    <resultMap id="BaseResultMap" type="com.chinawiserv.dsp.dir.entity.po.apply.DirDataApply">

    </resultMap>

    <resultMap id="BaseResultVoMap" extends="BaseResultMap"
               type="com.chinawiserv.dsp.dir.entity.vo.catalog.DirDataAuditVo">

    </resultMap>-->

    <!-- 通用查询过滤条件 -->
    <sql id="queryConditions">
        <where>
            <if test="id != null">
                t.id = #{id,jdbcType=VARCHAR}
            </if>
            <if test="searchKey != null">
                AND d.dataset_name LIKE concat(concat('%', #{searchKey}), '%')
            </if>
            <if test="isAudited == null or isAudited == '0'.toString()">
                AND (t.status = '0' OR t.status = '' OR t.status IS NULL)
            </if>
            <if test="isAudited != null and isAudited == '1'.toString()">
                AND (t.status = '1' OR t.status = '2')
            </if>
            <if test="regionCode != null and regionCode != ''">
                AND u.region_code = #{regionCode}
            </if>
            <if test="null != classifyId and '' != classifyId">
                AND dc.classify_id IN
                (SELECT
                id
                FROM
                dir_classify
                WHERE delete_flag = 0
                AND tree_code LIKE CONCAT(
                (SELECT
                tree_code
                FROM
                dir_classify
                WHERE delete_flag = 0
                AND id = #{classifyId, jdbcType=VARCHAR}),'%'))
            </if>
            <if test="null != userId and '' != userId">
                AND dc.classify_id IN(
                SELECT id  FROM dir_classify t,
                (SELECT dc.tree_code FROM dir_classify_authority dca
                LEFT JOIN dir_classify dc ON dca.classify_id = dc.id AND dc.delete_flag=0
                WHERE dca.auth_obj_type ='2' AND dca.auth_obj_id = #{userId,jdbcType=VARCHAR}
                ) a WHERE t.delete_flag=0 AND t.tree_code LIKE CONCAT(a.tree_code, ';%')
                UNION
                SELECT dca1.classify_id FROM dir_classify_authority dca1
                LEFT JOIN dir_classify dc1 ON dca1.classify_id = dc1.id AND dc1.delete_flag=0
                WHERE dca1.auth_obj_type ='2' AND dca1.auth_obj_id = #{userId,jdbcType=VARCHAR}
                UNION
                SELECT id  FROM dir_classify c,
                (SELECT dc.tree_code FROM dir_classify_authority dca
                LEFT JOIN dir_classify dc ON dca.classify_id = dc.id AND dc.delete_flag=0
                WHERE dca.auth_obj_type ='1' AND dca.auth_obj_id =  (SELECT su.dept_id FROM sys_user su WHERE su.delete_flag=0 AND su.id = #{userId,jdbcType=VARCHAR})
                )b WHERE c.delete_flag=0 AND c.tree_code LIKE CONCAT(b.tree_code, ';%')
                UNION
                SELECT dca2.classify_id FROM dir_classify_authority dca2
                LEFT JOIN dir_classify dc2 ON dca2.classify_id = dc2.id AND dc2.delete_flag=0
                WHERE dca2.auth_obj_type ='1' AND dca2.auth_obj_id =  (SELECT su.dept_id FROM sys_user su WHERE su.delete_flag=0 AND su.id = #{userId,jdbcType=VARCHAR})
                )
            </if>
        </where>
    </sql>

    <sql id="baseSelectVo">
        SELECT t.*,c.classify_structure_name,d.dataset_name,u.user_name,u.real_name,de.dept_name FROM dir_data_apply t
        LEFT JOIN dir_dataset_classify_map dc ON t.dcm_id = dc.id
        LEFT JOIN dir_classify c ON c.id = dc.classify_id
        LEFT JOIN dir_dataset d ON d.id = dc.dataset_id
        LEFT JOIN sys_user u ON u.id = t.applicant_id
        LEFT JOIN sys_dept de ON de.id = u.dept_id
    </sql>

    <select id="selectVoPage" parameterType="java.util.Map" resultType="com.chinawiserv.dsp.dir.entity.vo.apply.DirDataApplyVo">
        <include refid="baseSelectVo"></include>
        <include refid="queryConditions"></include>
    </select>

    <select id="selectVoById" parameterType="java.lang.String" resultType="com.chinawiserv.dsp.dir.entity.vo.apply.DirDataApplyVo">
        <include refid="baseSelectVo"></include> WHERE t.id = #{id}
    </select>

    <select id="selectVoCount" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(1) FROM (
        <include refid="baseSelectVo"></include>
        <include refid="queryConditions"></include>
        ) a
    </select>

</mapper>
