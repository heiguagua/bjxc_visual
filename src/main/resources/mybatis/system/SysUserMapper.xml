<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chinawiserv.dsp.base.mapper.system.SysUserMapper">

    <!-- 开启二级缓存 -->
    <!--<cache type="org.mybatis.caches.ehcache.LoggingEhcache"/>-->

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.chinawiserv.dsp.base.entity.po.system.SysUser">
        <id column="id" property="id"/>
        <result column="region_code" property="regionCode"/>
        <result column="user_name" property="userName"/>
        <result column="real_name" property="realName"/>
        <result column="password" property="password"/>
        <result column="token" property="token"/>
        <result column="user_type" property="userType"/>
        <result column="telephone_number" property="telephoneNumber"/>
        <result column="cell_phone_number" property="cellPhoneNumber"/>
        <result column="email" property="email"/>
        <result column="user_img" property="userImg"/>
        <result column="user_desc" property="userDesc"/>
        <result column="dept_id" property="deptId"/>
        <result column="status" property="status"/>
        <result column="create_user_id" property="createUserId"/>
        <result column="create_time" property="createTime"/>
        <result column="update_user_id" property="updateUserId"/>
        <result column="update_time" property="updateTime"/>
        <result column="delete_flag" property="deleteFlag"/>
    </resultMap>

    <!--定义vo映射-->
    <resultMap id="SysUserVoMap" type="com.chinawiserv.dsp.base.entity.vo.system.SysUserVo" extends="BaseResultMap">
        <result column="dept_name" property="deptName"/>
        <result column="create_name" property="createName"/>
        <result column="tree_code" property="deptTreeCode"/>
        <result column="region_name" property="regionName"/>
        <result column="region_level_value" property="regionLevel"/>
        <collection property="sysRoleList" javaType="list" column="id"
                    ofType="com.chinawiserv.dsp.base.entity.po.system.SysRole"
                    select="com.chinawiserv.dsp.base.mapper.system.SysRoleMapper.selectRolesByUserId"/>
    </resultMap>

    <!--定义页面vo查询字段-->
    <sql id="BaseVoSelectColumn">
		u1.*,u2.user_name as 'create_name',d.dept_name,d.tree_code, sr.region_name
	</sql>

    <!--定义vo查询语句-->
    <sql id="VoSelectSql">
        FROM sys_user u1
		LEFT JOIN sys_user u2 on u2.id = u1.create_user_id
		LEFT JOIN sys_dept d on u1.dept_id = d.id
		LEFT JOIN sys_region sr on u1.region_code = sr.region_code
	</sql>

    <!--定义vo查询条件-->
    <sql id="VoWhereCase">
        <trim prefix="where" prefixOverrides="and">
            u1.delete_flag = '0'
            <if test="searchKey != null">
                AND u1.user_name like CONCAT('%',#{searchKey,jdbcType=VARCHAR},'%')
            </if>
            <if test="deptTreeCodeCondition != null">
                AND (d.tree_code like CONCAT(#{deptTreeCodeCondition,jdbcType=VARCHAR},';','%') or d.tree_code=#{deptTreeCodeCondition})
            </if>
            <if test="regionCodeCondition != null">
                AND u1.region_code like '${regionCodeCondition}%'
            </if>
            <if test="defaultAuth != null">
                <if test="defaultAuth == '1'.toString()">
                  AND NOT EXISTS(SELECT auth_obj_id from sys_dept_authority WHERE auth_obj_type = '2' AND auth_obj_id = u1.id)
--                   非目录请注释下一行
                  AND NOT EXISTS(SELECT auth_obj_id from dir_classify_authority WHERE auth_obj_type = '2' AND auth_obj_id = u1.id)
                </if>
                <if test="defaultAuth == '0'.toString()">
                  AND (
                    EXISTS(SELECT auth_obj_id from sys_dept_authority WHERE auth_obj_type = '2' AND auth_obj_id = u1.id)
--                     非目录请注释下两行
                    OR
                    EXISTS(SELECT auth_obj_id from dir_classify_authority WHERE auth_obj_type = '2' AND auth_obj_id = u1.id)
                  )
                </if>
            </if>
            <if test="regionName != null and regionName != '' ">
                AND  sr.region_name like CONCAT('%',#{regionName},'%')
            </if>
            <if test="deptName != null and deptName != '' ">
                AND  d.dept_name like CONCAT('%',#{deptName},'%')
            </if>
        </trim>
    </sql>

    <!--页面用户列表查询-->
    <select id="selectVoList" resultType="com.chinawiserv.dsp.base.entity.vo.system.SysUserVo">
        SELECT DISTINCT
        <include refid="BaseVoSelectColumn"/>
        <include refid="VoSelectSql"/>
        LEFT JOIN sys_user_role ur ON u1.id = ur.user_id
        LEFT JOIN sys_role r ON r.id = ur.role_id
        <include refid="VoWhereCase"/>
        AND (r.delete_flag = '0' or r.delete_flag is null) AND (r.role_level &gt; ${roleLevel} or r.role_level is null)
    </select>

    <select id="selectVoCount" parameterType="java.util.Map" resultType="int">
        select count(DISTINCT u1.user_name)
        <include refid="VoSelectSql"/>
        LEFT JOIN sys_user_role ur ON u1.id = ur.user_id
        LEFT JOIN sys_role r ON r.id = ur.role_id
        <include refid="VoWhereCase"/>
        AND r.delete_flag = '0' AND r.role_level &gt; ${roleLevel}
    </select>

    <!--根据id查找用户-->
    <select id="selectVoById" resultMap="SysUserVoMap">
        SELECT
        <include refid="BaseVoSelectColumn"/>
        <include refid="VoSelectSql"/>
        WHERE u1.id = #{id}
	</select>

    <select id="selectUserList" resultType="HashMap">
        SELECT u.id,u.region_code AS regionCode, u.user_name AS userName,u.`password`,u.user_state AS
        userState,u.create_time AS createTime,
        u.user_desc AS userDesc,u.user_img AS userImg,u.dept_id AS deptId,d.`dept_name` AS deptName FROM `sys_user` u
        LEFT JOIN `sys_dept` d ON d.`id` = u.`dept_id` WHERE 1=1
        <if test="search != null">
            AND u.user_name LIKE CONCAT('%',#{search,jdbcType=VARCHAR},'%')
        </if>
        ORDER BY u.`create_time` DESC
    </select>
    <select id="selectVoByUserName" parameterType="java.lang.String" resultMap="SysUserVoMap">
        SELECT
        u1.*,
        u2.user_name AS 'create_name',
        sr.region_name,
        srl.region_level_value,
        d.dept_name,
        d.tree_code
        FROM
        sys_user u1 FORCE INDEX (Index_sysuser_username_info)
        LEFT JOIN sys_region sr
        ON u1.region_code = sr.region_code
        LEFT JOIN `sys_region_level` srl
        ON srl.region_level_code = sr.region_level_code
        LEFT JOIN sys_user u2 FORCE INDEX (Index_sysuser_id_username)
        ON u2.id = u1.create_user_id
        LEFT JOIN sys_dept d FORCE INDEX (
        Index_sysdept_id_treecode_deptname
        )
        ON d.id = u1.dept_id
        WHERE u1.user_name = '${userName}'
        AND u1.delete_flag = 0
    </select>
    <select id="selectUsersCountByRoleId" parameterType="java.lang.String" resultType="int">
		SELECT count(1) from sys_user u
		LEFT JOIN sys_user_role ur ON u.id = ur.user_id
		LEFT JOIN sys_role r ON r.id = ur.role_id
		WHERE u.delete_flag = '0' AND r.delete_flag = '0' AND r.id = #{roleId}
	</select>
    <select id="selectUsersCountByDeptId" parameterType="java.lang.String" resultType="int">
		SELECT count(1) from sys_user u
		WHERE u.delete_flag = '0'  AND u.dept_id = #{deptId}
	</select>
    <select id="checkCanBeDeletedById" parameterType="java.lang.String" resultType="java.lang.Boolean">
		SELECT EXISTS (
		SELECT 1 from sys_user u
		LEFT JOIN sys_user_role ur ON u.id = ur.user_id
		LEFT JOIN sys_role r ON r.id = ur.role_id
		WHERE u.delete_flag = '0'
		AND r.delete_flag = '0'
		AND r.role_level &gt;= 0
		AND u.id = #{userId}
		)
	</select>
    <!--	<resultMap id="BaseResultMapVo" type="com.chinawiserv.dsp.dcs.dcm.entity.vo.base.SysUserVo" extends="BaseResultMap">

        </resultMap>
        <sql id="baseColumnVoSql">
            t.id,t.name,t.password,t.coumn3
        </sql>
        <sql id="whereCause">
            <trim prefix="where" prefixOverrides="and">
                <if test="id != null" >
                    and t.ID = #{id,jdbcType=VARCHAR}
                </if>
                <if test="ids != null">
                    and t.ID in
                    <foreach collection="ids" open="(" close=")" item="item" separator=",">
                        #{item, jdbcType=VARCHAR}
                    </foreach>
                </if>

                <if test="sysType != null" >
                    and t.SYS_TYPE = #{sysType,jdbcType=VARCHAR}
                </if>
                <if test="sysTypes != null">
                    and t.SYS_TYPE in
                    <foreach collection="ids" open="(" close=")" item="item" separator=",">
                        #{item, jdbcType=VARCHAR}
                    </foreach>
                </if>
                <if test="moduleName != null" >
                    and t.MODULE_NAME = #{moduleName,jdbcType=VARCHAR}
                </if>
                <if test="moduleNameDesc != null" >
                    and t.MODULE_NAME_DESC = #{moduleNameDesc,jdbcType=VARCHAR}
                </if>
                <if test="moduleSign != null" >
                    and t.MODULE_SIGN = #{moduleSign,jdbcType=VARCHAR}
                </if>
                <if test="moduleUrl != null" >
                    and t.MODULE_URL = #{moduleUrl,jdbcType=VARCHAR}
                </if>
                <if test="moduleOrder != null" >
                    and t.MODULE_ORDER = #{moduleOrder,jdbcType=DECIMAL}
                </if>
            </trim>
        </sql>
        <sql id="voSelectSql" >
            from sys_user t
            left join sys_role_user sru
        </sql>
        <sql id="selfOrderBy">

        </sql>

        <select id="selectVoList" parameterType="java.util.Map" resultMap="BaseResultMapVo">
            select <include refid="baseColumnVoSql"/>
            <include refid="voSelectSql"/>
            <include refid="whereCause"/>
            <include refid="selfOrderBy"/>
            <include refid="com.chinawiserv.dsp.dcs.dcm.mapper.common.ICommonMapper.pagination"/>
        </select>

        <select id="selectVoCount" parameterType="java.util.Map" resultType="int">
            select count(1)
            <include refid="voSelectSql"/>
            <include refid="whereCause"/>
        </select>-->

    <select id="selectUserRoleType" resultType="java.lang.Integer">
        SELECT MIN(sr.role_level)
        FROM sys_user su
        LEFT JOIN sys_user_role sur ON su.id=sur.user_id
        LEFT JOIN sys_role sr ON sur.role_id=sr.id
        WHERE TRUE AND su.id=#{user_id}
    </select>

    <update id="createToken" parameterType="java.util.Map">
        UPDATE sys_user SET token = #{token}
        WHERE id = #{id}
    </update>

    <update id="deleteBatchUserByIds" parameterType="java.util.List">
        UPDATE sys_user SET delete_flag = '1' WHERE id IN
        <foreach collection="list" item="item" index="index" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <select id="listBySystemId" parameterType="java.lang.String" resultType="com.chinawiserv.dsp.base.entity.po.system.SysUser">
        SELECT u.* FROM sys_user u
        -- 		WHERE
    </select>

    <select id="selectSXUser" parameterType="com.chinawiserv.dsp.base.entity.po.system.SysUser" resultType="com.chinawiserv.dsp.base.entity.po.system.SysUser">
        select * from sys_user
        <where>
            1 = 1
            <if test="deptId != null">
                and dept_id = #{deptId}
            </if>
            <if test="userName != null">
                and user_name = #{userName}
            </if>
            <if test="realName != null">
                and real_name = #{realName}
            </if>
            <if test="password != null">
                and password = #{password}
            </if>
            <if test="telephoneNumber != null">
                and telephone_number = #{telephoneNumber}
            </if>
            <if test="cellPhoneNumber != null">
                and cell_phone_number = #{cellPhoneNumber}
            </if>
            <if test="email != null">
                and email = #{email}
            </if>
            <if test="userImg != null">
                and user_img = #{userImg}
            </if>
            <if test="userDesc != null">
                and user_desc = #{userDesc}
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
            <if test="createUserId != null">
                and create_user_id = #{createUserId}
            </if>
            <if test="createTime != null">
                and create_time = #{createTime}
            </if>
            <if test="updateUserId != null">
                and update_user_id = #{updateUserId}
            </if>
            <if test="updateTime != null">
                and update_time = #{updateTime}
            </if>
            and id = #{id}
        </where>
    </select>

    <update id="updateSXUser" parameterType="com.chinawiserv.dsp.base.entity.po.system.SysUser">
        update sys_user
        <set>
            <if test="deptId != null">
                dept_id = #{deptId},
            </if>
            <if test="userName != null">
                user_name = #{userName},
            </if>
            <if test="realName != null">
                real_name = #{realName},
            </if>
            <if test="password != null">
                password = #{password},
            </if>
            <if test="telephoneNumber != null">
                telephone_number = #{telephoneNumber},
            </if>
            <if test="cellPhoneNumber != null">
                cell_phone_number = #{cellPhoneNumber},
            </if>
            <if test="email != null">
                email = #{email},
            </if>
            <if test="userImg != null">
                user_img = #{userImg},
            </if>
            <if test="userDesc != null">
                user_desc = #{userDesc},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="createUserId != null">
                create_user_id = #{createUserId},
            </if>
            <if test="createTime != null">
                create_time = #{createTime},
            </if>
            <if test="updateUserId != null">
                update_user_id = #{updateUserId},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime},
            </if>
        </set>
        where id = #{id}

    </update>

</mapper>
